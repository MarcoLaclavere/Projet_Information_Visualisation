<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Map with Zoomable and Clickable Pie Charts</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    svg {
      width: 100%;
      height: 80vh;
    }
    .country-chart {
      position: absolute;
      text-align: center;
    }
    .country-label {
      font-weight: bold;
      font-size: 10px;
    }
    /* Styles pour le tooltip */
    .tooltip {
      position: fixed;
      top: 10%;
      right: 10px; /* Positionner le tooltip sur le côté droit */
      background-color: white;
      border: 1px solid #ccc;
      padding: 10px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
      display: none; /* Cacher par défaut */
      z-index: 10;
      width: 200px; /* Ajustez la largeur de la fenêtre du tooltip */
      height: 200px;
    }
    .tooltip-close {
      cursor: pointer;
      font-weight: bold;
      color: red;
    }
  </style>
</head>
<body>
  <div>
    <input type="checkbox" id="toggleMiscellaneous" checked>
    <label for="toggleMiscellaneous">Afficher le genre Miscellaneous</label>
  </div>
  <div id="map-container"></div>

  <!-- Tooltip pour afficher un pie chart agrandi -->
  <div id="tooltip" class="tooltip">
    <span class="tooltip-close">Fermer</span>
    <svg id="tooltip-chart" width="200" height="200"></svg>
  </div>

  <script>
    const width = 960;
    const height = 600;

    Promise.all([
      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
      d3.json("../json/aggregatedData.json")  // Mettez ici le chemin vers votre fichier JSON
    ]).then(([geoData, genreData]) => {
      document.getElementById('toggleMiscellaneous').addEventListener('change', () => {
        updateMap(geoData, genreData);
      });

      updateMap(geoData, genreData);
    }).catch(error => console.error('Erreur lors du chargement des données :', error));

    function updateMap(geoData, genreData) {
      d3.select("#map-container").selectAll("svg").remove();

      const projection = d3.geoMercator().scale(130).translate([width / 2, height / 2]);
      const path = d3.geoPath().projection(projection);

      const svg = d3.select("#map-container").append("svg").attr("width", width).attr("height", height);
      const g = svg.append("g");

      const color = d3.scaleOrdinal(d3.schemeCategory10);
      let currentZoom = 1;

      function updateElements() {
        g.selectAll(".country-chart").each(function(d, i, nodes) {
          const pieGroup = d3.select(nodes[i]);
          const radius = 40 / currentZoom;
          const arc = d3.arc().innerRadius(0).outerRadius(radius);

          pieGroup.selectAll("path")
            .attr("d", arc);

          pieGroup.select("text.country-label")
            .attr("dy", radius + 2)
            .style("font-size", `${10 / currentZoom}px`);
        });
      }

      svg.call(d3.zoom()
        .scaleExtent([1, 8])
        .on("zoom", (event) => {
          currentZoom = event.transform.k;
          g.attr("transform", event.transform);
          updateElements();
        })
      );

      g.append("g")
        .selectAll("path")
        .data(geoData.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", "#ccc")
        .attr("stroke", "#333");

      genreData.forEach(countryData => {
        const countryName = countryData.country;
        const genres = countryData.genres;

        const showMiscellaneous = document.getElementById('toggleMiscellaneous').checked;
        const filteredGenres = Object.entries(genres).filter(([genre]) => showMiscellaneous || genre !== "Miscellaneous");

        const pieData = filteredGenres.map(([genre, count]) => ({
          genre,
          count
        }));

        const countryGeo = geoData.features.find(d => d.properties.name === countryName);
        if (!countryGeo) return;
        const [x, y] = path.centroid(countryGeo);

        const initialRadius = 40;
        const arc = d3.arc().innerRadius(0).outerRadius(initialRadius);
        const pie = d3.pie().value(d => d.count);

        const pieGroup = g.append("g")
          .attr("transform", `translate(${x}, ${y})`)
          .attr("class", "country-chart")
          .on("click", () => showTooltip(countryName, pieData, color)); // Ajoute l'interactivité

        pieGroup.selectAll("path")
          .data(pie(pieData))
          .enter()
          .append("path")
          .attr("d", arc)
          .attr("fill", d => color(d.data.genre))
          .append("title")
          .text(d => `${d.data.genre}: ${d.data.count}`);

        pieGroup.append("text")
          .attr("dy", initialRadius + 2)
          .attr("text-anchor", "middle")
          .attr("class", "country-label")
          .text(countryName)
          .style("font-size", `${10}px`);
      });
    }

    // Fonction pour afficher le tooltip avec un pie chart agrandi
    function showTooltip(countryName, pieData, color) {
      const tooltip = d3.select("#tooltip");
      tooltip.style("display", "block");

      const svg = d3.select("#tooltip-chart");
      svg.selectAll("*").remove();

      const radius = 80; // Taille agrandie pour le pie chart dans le tooltip
      const arc = d3.arc().innerRadius(0).outerRadius(radius);
      const pie = d3.pie().value(d => d.count);

      svg.append("g")
        .attr("transform", `translate(100, 100)`)
        .selectAll("path")
        .data(pie(pieData))
        .enter()
        .append("path")
        .attr("d", arc)
        .attr("fill", d => color(d.data.genre))
        .append("title")
        .text(d => `${d.data.genre}: ${d.data.count}`);

      // Affiche le nom du pays dans le tooltip
      svg.append("text")
        .attr("x", 100)
        .attr("y", 10)
        .attr("text-anchor", "middle")
        .text(countryName)
        .style("font-weight", "bold");

      // Ferme le tooltip au clic sur le bouton "Fermer"
      d3.select(".tooltip-close").on("click", () => tooltip.style("display", "none"));
    }
  </script>
</body>
</html>
